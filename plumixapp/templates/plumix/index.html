{% extends "plumix/base.html" %}
{% load static %}

{% block title %}Dashboard • Plumix{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-3">
  <h1 class="h3 mb-0 text-gray-800">Dashboard</h1>
</div>

<!-- Filtros -->
<form method="get" class="row g-2 align-items-end mb-4">
  <div class="col-sm-3">
    <label class="form-label mb-1">Período (dias)</label>
    <select name="dias" class="form-control">
      {% for d in periodos %}
        <option value="{{ d }}" {% if d == periodo_dias %}selected{% endif %}>{{ d }} dias</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-sm-5">
    <label class="form-label mb-1">Lote</label>
    <select name="lote" class="form-control">
      <option value="" {% if not lote_selected %}selected{% endif %}>Todos os lotes</option>
      {% for l in lotes %}
        <option value="{{ l.pk }}" {% if lote_selected and lote_selected.pk == l.pk %}selected{% endif %}>
          {{ l.nome_lote }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-sm-4">
    <button class="btn btn-primary">Aplicar filtros</button>
    {% if request.GET %}
      <a href="{% url 'index' %}" class="btn btn-outline-secondary">Limpar</a>
    {% endif %}
  </div>
</form>

<!-- Row: KPI Cards -->
<div class="row">
  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-success shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Lotes Ativos</div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ lotes_ativos }} / {{ total_lotes }}</div>
          </div>
          <div class="col-auto"><i class="fas fa-layer-group fa-2x text-gray-300"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-danger shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
              Mortalidade ({{ periodo_dias }} dias{% if lote_selected %}, {{ lote_selected.nome_lote }}{% endif %})
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ mortal_30d }}</div>
          </div>
          <div class="col-auto"><i class="fas fa-skull-crossbones fa-2x text-gray-300"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-info shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
              Ração ({{ periodo_dias }} dias{% if lote_selected %}, {{ lote_selected.nome_lote }}{% endif %})
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ racao_30d|floatformat:2 }} kg</div>
          </div>
          <div class="col-auto"><i class="fas fa-drumstick-bite fa-2x text-gray-300"></i></div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-xl-3 col-md-6 mb-4">
    <div class="card border-left-primary shadow h-100 py-2">
      <div class="card-body">
        <div class="row no-gutters align-items-center">
          <div class="col mr-2">
            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
              Água ({{ periodo_dias }} dias{% if lote_selected %}, {{ lote_selected.nome_lote }}{% endif %})
            </div>
            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ agua_30d|floatformat:2 }} L</div>
          </div>
          <div class="col-auto"><i class="fas fa-tint fa-2x text-gray-300"></i></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Peso x Idade -->
  <div class="col-xl-8 col-lg-7">
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">
          Peso Médio x Idade
          {% if lote_ref %}<small class="text-muted"> (Lote: {{ lote_ref.nome_lote }})</small>{% endif %}
        </h6>
      </div>
      <div class="card-body"><div class="chart-area"><canvas id="pesoIdadeChart"></canvas></div></div>
    </div>
  </div>

  <!-- Mortalidade por Causa -->
  <div class="col-xl-4 col-lg-5">
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">Mortalidade por Causa ({{ periodo_dias }} dias)</h6>
      </div>
      <div class="card-body">
        <div class="chart-pie pt-4 pb-2"><canvas id="mortalPieChart"></canvas></div>
        {% if not mort_labels %}
          <div class="mt-2 text-center small text-muted">Sem dados no período selecionado.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
<div class="row">
  <div class="col-12">
    <div class="card shadow mb-4">
      <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
        <h6 class="m-0 font-weight-bold text-primary">
          Consumo Diário — Ração (kg) x Água (L)
          <small class="text-muted">({{ periodo_dias }} dias{% if lote_selected %}, {{ lote_selected.nome_lote }}{% endif %})</small>
        </h6>
      </div>
      <div class="card-body">
        <div style="height:320px">
          <canvas id="consumoBarChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>



{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/chart.js/Chart.min.js' %}"></script>
<script>
  const pesoIdadeLabels = {{ peso_idade_labels|safe }};
  const pesoIdadeValues = {{ peso_idade_values|safe }};
  const mortLabels = {{ mort_labels|safe }};
  const mortValues = {{ mort_values|safe }};

  // --- Line: Peso x Idade (mantém igual) ---
  (function(){
    const ctx = document.getElementById('pesoIdadeChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: { labels: pesoIdadeLabels, datasets: [{ label: 'Peso médio (g)', data: pesoIdadeValues, fill: true, tension: 0.3 }] },
      options: {
        maintainAspectRatio: false,
        scales: {
          x: { title: { display: true, text: 'Idade (dias)' } },
          y: { title: { display: true, text: 'Peso (g)' }, beginAtZero: false }
        }
      }
    });
  })();

  // --- Util: gera cor estável a partir do texto ---
  function hashHue(str){
    let h = 0;
    for (let i = 0; i < str.length; i++) {
      h = (h << 5) - h + str.charCodeAt(i);
      h |= 0; // 32-bit
    }
    return (h % 360 + 360) % 360; // 0..359
  }

  // --- Pie: Mortalidade por Causa (com cores por causa) ---
  (function(){
    const ctx = document.getElementById('mortalPieChart').getContext('2d');

    const mortBackground = mortLabels.map(lbl => `hsl(${hashHue(lbl)}, 70%, 55%)`);
    const mortBorder     = mortLabels.map(lbl => `hsl(${hashHue(lbl)}, 70%, 35%)`);

    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: mortLabels,
        datasets: [{
          data: mortValues,
          backgroundColor: mortBackground,
          borderColor: mortBorder,
          borderWidth: 1
        }]
      },
      options: {
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ctx) => {
                const total = ctx.dataset.data.reduce((a, b) => a + b, 0) || 1;
                const val = ctx.parsed || 0;
                const pct = (val * 100 / total).toFixed(1);
                return `${ctx.label}: ${val} (${pct}%)`;
              }
            }
          }
        }
      }
    });
  })();
</script>

<script>
  const dailyLabels = {{ daily_labels|safe }};
  const racaoDaily = {{ racao_daily_values|safe }};
  const aguaDaily  = {{ agua_daily_values|safe }};

  (function(){
    const ctx = document.getElementById('consumoBarChart').getContext('2d');

    // cores consistentes (HSL) p/ cada dataset
    const racaoBg   = 'hsl(28, 90%, 55%)';  // laranja quente
    const racaoBord = 'hsl(28, 90%, 40%)';
    const aguaBg    = 'hsl(205, 80%, 55%)'; // azul
    const aguaBord  = 'hsl(205, 80%, 40%)';

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: dailyLabels,
        datasets: [
          {
            label: 'Ração (kg)',
            data: racaoDaily,
            backgroundColor: racaoBg,
            borderColor: racaoBord,
            borderWidth: 1,
            order: 1,
            categoryPercentage: 0.6,
            barPercentage: 0.9
          },
          {
            label: 'Água (L)',
            data: aguaDaily,
            backgroundColor: aguaBg,
            borderColor: aguaBord,
            borderWidth: 1,
            order: 2,
            categoryPercentage: 0.6,
            barPercentage: 0.9
          }
        ]
      },
      options: {
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toLocaleString('pt-BR')}`
            }
          }
        },
        scales: {
          x: { stacked: false },
          y: { beginAtZero: true }
        }
      }
    });
  })();
</script>


{% endblock %}
